{"version":3,"sources":["../src/worldmap.js"],"names":["_","L","tileServers","url","attribution","subdomains","WorldMap","ctrl","mapContainer","createMap","circles","heatData","mapCenter","window","latLng","parseFloat","panel","mapCenterLatitude","mapCenterLongitude","map","worldCopyJump","center","fitWorld","zoomIn","parseInt","initialZoom","panTo","selectedTileServer","tileServer","tileLayer","maxZoom","reuseTiles","detectRetina","addTo","legend","control","position","onAdd","_div","DomUtil","create","update","thresholds","data","legendHtml","colors","index","length","getColor","innerHTML","mapType","clearHeat","drawCircles","clearCircles","drawHeat","nCirc","size","locations","Set","dataPoints","isEqual","filter","o","hideEmpty","isNil","value","hideZero","circlesLayer","clearLayers","removeCircles","heatLayer","removeLayer","filterEmptyAndZeroValues","needToRedrawCircles","createCircles","updateCircles","forEach","dataPoint","locationName","key","createCircle","addCircles","values","circle","setRadius","calcCircleSize","setStyle","color","fillColor","fillOpacity","location","unbindPopup","createPopup","valueRounded","circleMarker","locationLatitude","locationLongitude","radius","dataPointValue","circleMinSize","circleMaxSize","valueRange","dataFactor","lowestValue","circleSizeRange","unit","unitSingular","unitPlural","label","trim","bindPopup","point","stickyLabels","on","onMouseOver","evt","layer","target","bringToFront","openPopup","onMouseOut","closePopup","first","rgb","match","toString","slice","minValue","min","maxValue","max","normalizedValue","heatPoint","push","maxGrad","minGrad","mapMaxVal","gradientData","rgb2hex","thresh","heatSize","blur","heatBlur","heatOpts","gradient","invalidateSize","mapCenterMoved","removeFrom","layerGroup","zoomFactor","setZoom","removeLegend","remove"],"mappings":";;;;;;;;;;;;;;;AAAOA,O;;AAGAC,O;;;;;;;;;;;;;;;;;;;;;AAIDC,iB,GAAc;AAClB,4BAAoB,EAAEC,KAAK,8EAAP,EAAuFC,aAAa,wIAApG,EAA8OC,YAAY,MAA1P,EADF;AAElB,wBAAgB,EAACF,KAAK,6EAAN,EAAqFC,aAAa,wIAAlG,EAA4OC,YAAY,MAAxP;AAFE,O;;AAKCC,c;AACnB,0BAAYC,IAAZ,EAAkBC,YAAlB,EAAgC;AAAA;;AAC9B,eAAKD,IAAL,GAAYA,IAAZ;AACA,eAAKC,YAAL,GAAoBA,YAApB;AACA,eAAKC,SAAL;AACA,eAAKC,OAAL,GAAe,EAAf;AACA,eAAKC,QAAL,GAAgB,EAAhB;AACD;;;;sCAEW;AACV,gBAAMC,YAAYC,OAAOZ,CAAP,CAASa,MAAT,CAAgBC,WAAW,KAAKR,IAAL,CAAUS,KAAV,CAAgBC,iBAA3B,CAAhB,EAA+DF,WAAW,KAAKR,IAAL,CAAUS,KAAV,CAAgBE,kBAA3B,CAA/D,CAAlB;AACA,iBAAKC,GAAL,GAAWN,OAAOZ,CAAP,CAASkB,GAAT,CAAa,KAAKX,YAAlB,EAAgC,EAACY,eAAe,IAAhB,EAAsBC,QAAQT,SAA9B,EAAhC,EACRU,QADQ,GAERC,MAFQ,CAEDC,SAAS,KAAKjB,IAAL,CAAUS,KAAV,CAAgBS,WAAzB,EAAsC,EAAtC,CAFC,CAAX;AAGA,iBAAKN,GAAL,CAASO,KAAT,CAAed,SAAf;;AAEA,gBAAMe,qBAAqBzB,YAAY,KAAKK,IAAL,CAAUqB,UAAtB,CAA3B;AACAf,mBAAOZ,CAAP,CAAS4B,SAAT,CAAmBF,mBAAmBxB,GAAtC,EAA2C;AACzC2B,uBAAS,EADgC;AAEzCzB,0BAAYsB,mBAAmBtB,UAFU;AAGzC0B,0BAAY,IAH6B;AAIzCC,4BAAc,IAJ2B;AAKzC5B,2BAAauB,mBAAmBvB;AALS,aAA3C,EAMG6B,KANH,CAMS,KAAKd,GANd;AAOD;;;yCAEc;AAAA;;AACb,iBAAKe,MAAL,GAAcrB,OAAOZ,CAAP,CAASkC,OAAT,CAAiB,EAACC,UAAU,YAAX,EAAjB,CAAd;AACA,iBAAKF,MAAL,CAAYG,KAAZ,GAAoB,YAAM;AACxB,oBAAKH,MAAL,CAAYI,IAAZ,GAAmBzB,OAAOZ,CAAP,CAASsC,OAAT,CAAiBC,MAAjB,CAAwB,KAAxB,EAA+B,aAA/B,CAAnB;AACA,oBAAKN,MAAL,CAAYO,MAAZ;AACA,qBAAO,MAAKP,MAAL,CAAYI,IAAnB;AACD,aAJD;;AAMA,iBAAKJ,MAAL,CAAYO,MAAZ,GAAqB,YAAM;AACzB,kBAAMC,aAAa,MAAKnC,IAAL,CAAUoC,IAAV,CAAeD,UAAlC;AACA,kBAAIE,aAAa,EAAjB;AACAA,4BAAc,0BAA0B,MAAKrC,IAAL,CAAUS,KAAV,CAAgB6B,MAAhB,CAAuB,CAAvB,CAA1B,GAAsD,SAAtD,GACV,OADU,GACAH,WAAW,CAAX,CADA,GACgB,MAD9B;AAEA,mBAAK,IAAII,QAAQ,CAAjB,EAAoBA,QAAQJ,WAAWK,MAAvC,EAA+CD,SAAS,CAAxD,EAA2D;AACzDF,8BACE,0BAA0B,MAAKI,QAAL,CAAcN,WAAWI,KAAX,IAAoB,CAAlC,CAA1B,GAAiE,SAAjE,GACAJ,WAAWI,KAAX,CADA,IACqBJ,WAAWI,QAAQ,CAAnB,IAAwB,YAAYJ,WAAWI,QAAQ,CAAnB,CAAZ,GAAoC,MAA5D,GAAqE,GAD1F,CADF;AAGD;AACD,oBAAKZ,MAAL,CAAYI,IAAZ,CAAiBW,SAAjB,GAA6BL,UAA7B;AACD,aAXD;AAYA,iBAAKV,MAAL,CAAYD,KAAZ,CAAkB,KAAKd,GAAvB;AACD;;;wCAEa;AACZ,oBAAQ,KAAKZ,IAAL,CAAUoC,IAAV,CAAeO,OAAvB;AACE,mBAAK,QAAL;AACE,qBAAKC,SAAL;AACA,qBAAKC,WAAL;AACA;AACF,mBAAK,MAAL;AACE,qBAAKC,YAAL;AACA,qBAAKC,QAAL;AACA;AACF;AACE;AAVJ;AAYD;;;8CAEmBX,I,EAAM;AACxB,gBAAIY,QAAQvD,EAAEwD,IAAF,CAAO,KAAK9C,OAAZ,CAAZ;AACA,gBAAI6C,UAAU,CAAV,IAAeZ,KAAKI,MAAL,GAAc,CAAjC,EAAoC,OAAO,IAAP;AACpC,gBAAIQ,UAAUZ,KAAKI,MAAnB,EAA2B,OAAO,IAAP;AAC3B,gBAAMU,YAAY,IAAIC,GAAJ,CAAQ1D,EAAEmB,GAAF,CAAMnB,EAAEmB,GAAF,CAAM,KAAKT,OAAX,EAAoB,SAApB,CAAN,EAAsC,UAAtC,CAAR,CAAlB;AACA,gBAAMiD,aAAa,IAAID,GAAJ,CAAQ1D,EAAEmB,GAAF,CAAMwB,IAAN,EAAY,KAAZ,CAAR,CAAnB;AACA,mBAAO,CAAC3C,EAAE4D,OAAF,CAAUH,SAAV,EAAqBE,UAArB,CAAR;AACD;;;mDAEwBhB,I,EAAM;AAAA;;AAC7B,mBAAO3C,EAAE6D,MAAF,CAASlB,IAAT,EAAe,UAACmB,CAAD,EAAO;AAAE,qBAAO,EAAE,OAAKvD,IAAL,CAAUS,KAAV,CAAgB+C,SAAhB,IAA6B/D,EAAEgE,KAAF,CAAQF,EAAEG,KAAV,CAA/B,KAAoD,EAAE,OAAK1D,IAAL,CAAUS,KAAV,CAAgBkD,QAAhB,IAA4BJ,EAAEG,KAAF,KAAY,CAA1C,CAA3D;AAA0G,aAAlI,CAAP;AACD;;;yCAEc;AACb,gBAAI,KAAKE,YAAT,EAAuB;AACrB,mBAAKA,YAAL,CAAkBC,WAAlB;AACA,mBAAKC,aAAL,CAAmB,KAAKF,YAAxB;AACA,mBAAKzD,OAAL,GAAe,EAAf;AACD;AACF;;;sCAEW;AACV,gBAAI,KAAK4D,SAAT,EAAoB;AAClB,mBAAKnD,GAAL,CAASoD,WAAT,CAAqB,KAAKD,SAA1B;AACD;AACD,iBAAK3D,QAAL,GAAgB,EAAhB;AACD;;;wCAEa;AACZ,gBAAMgC,OAAO,KAAK6B,wBAAL,CAA8B,KAAKjE,IAAL,CAAUoC,IAAxC,CAAb;AACA,gBAAI,KAAK8B,mBAAL,CAAyB9B,IAAzB,CAAJ,EAAoC;AAClC,mBAAKU,YAAL;AACA,mBAAKqB,aAAL,CAAmB/B,IAAnB;AACD,aAHD,MAGO;AACL,mBAAKgC,aAAL,CAAmBhC,IAAnB;AACD;AACF;;;wCAEaA,I,EAAM;AAAA;;AAClB,gBAAMjC,UAAU,EAAhB;AACAiC,iBAAKiC,OAAL,CAAa,qBAAa;AACxB,kBAAI,CAACC,UAAUC,YAAf,EAA6B;AAC7BpE,sBAAQmE,UAAUE,GAAlB,IAAyB,OAAKC,YAAL,CAAkBH,SAAlB,CAAzB;AACD,aAHD;AAIA,iBAAKV,YAAL,GAAoB,KAAKc,UAAL,CAAgBjF,EAAEkF,MAAF,CAASxE,OAAT,CAAhB,CAApB;AACA,iBAAKA,OAAL,GAAeA,OAAf;AACD;;;wCAEaiC,I,EAAM;AAAA;;AAClBA,iBAAKiC,OAAL,CAAa,UAACC,SAAD,EAAe;AAC1B,kBAAI,CAACA,UAAUC,YAAf,EAA6B;;AAE7B,kBAAMK,SAAS,OAAKzE,OAAL,CAAamE,UAAUE,GAAvB,CAAf;;AAEA,kBAAII,MAAJ,EAAY;AACVA,uBAAOC,SAAP,CAAiB,OAAKC,cAAL,CAAoBR,UAAUZ,KAAV,IAAmB,CAAvC,CAAjB;AACAkB,uBAAOG,QAAP,CAAgB;AACdC,yBAAO,OAAKvC,QAAL,CAAc6B,UAAUZ,KAAxB,CADO;AAEduB,6BAAW,OAAKxC,QAAL,CAAc6B,UAAUZ,KAAxB,CAFG;AAGdwB,+BAAa,GAHC;AAIdC,4BAAUb,UAAUE;AAJN,iBAAhB;AAMAI,uBAAOQ,WAAP;AACA,uBAAKC,WAAL,CAAiBT,MAAjB,EAAyBN,UAAUC,YAAnC,EAAiDD,UAAUgB,YAA3D;AACD;AACF,aAhBD;AAiBD;;;uCAEYhB,S,EAAW;AACtB,gBAAMM,SAAStE,OAAOZ,CAAP,CAAS6F,YAAT,CAAsB,CAACjB,UAAUkB,gBAAX,EAA6BlB,UAAUmB,iBAAvC,CAAtB,EAAiF;AAC9FC,sBAAQ,KAAKZ,cAAL,CAAoBR,UAAUZ,KAAV,IAAmB,CAAvC,CADsF;AAE9FsB,qBAAO,KAAKvC,QAAL,CAAc6B,UAAUZ,KAAxB,CAFuF;AAG9FuB,yBAAW,KAAKxC,QAAL,CAAc6B,UAAUZ,KAAxB,CAHmF;AAI9FwB,2BAAa,GAJiF;AAK9FC,wBAAUb,UAAUE;AAL0E,aAAjF,CAAf;;AAQA,iBAAKa,WAAL,CAAiBT,MAAjB,EAAyBN,UAAUC,YAAnC,EAAiDD,UAAUgB,YAA3D;AACA,mBAAOV,MAAP;AACD;;;yCAEce,c,EAAgB;AAC7B,gBAAMC,gBAAgB3E,SAAS,KAAKjB,IAAL,CAAUS,KAAV,CAAgBmF,aAAzB,EAAwC,EAAxC,KAA+C,CAArE;AACA,gBAAMC,gBAAgB5E,SAAS,KAAKjB,IAAL,CAAUS,KAAV,CAAgBoF,aAAzB,EAAwC,EAAxC,KAA+C,EAArE;;AAEA,gBAAI,KAAK7F,IAAL,CAAUoC,IAAV,CAAe0D,UAAf,KAA8B,CAAlC,EAAqC;AACnC,qBAAOD,aAAP;AACD;;AAED,gBAAME,aAAa,CAACJ,iBAAiB,KAAK3F,IAAL,CAAUoC,IAAV,CAAe4D,WAAjC,IAAgD,KAAKhG,IAAL,CAAUoC,IAAV,CAAe0D,UAAlF;AACA,gBAAMG,kBAAkBJ,gBAAgBD,aAAxC;;AAEA,mBAAQK,kBAAkBF,UAAnB,GAAiCH,aAAxC;AACD;;;sCAEWhB,M,EAAQL,Y,EAAcb,K,EAAO;AACvC,gBAAMwC,OAAOxC,SAASA,UAAU,CAAnB,GAAuB,KAAK1D,IAAL,CAAUS,KAAV,CAAgB0F,YAAvC,GAAsD,KAAKnG,IAAL,CAAUS,KAAV,CAAgB2F,UAAnF;AACA,gBAAMC,QAAQ,CAAC9B,eAAe,IAAf,GAAsBb,KAAtB,GAA8B,GAA9B,IAAqCwC,QAAQ,EAA7C,CAAD,EAAmDI,IAAnD,EAAd;AACA1B,mBAAO2B,SAAP,CAAiBF,KAAjB,EAAwB,EAAC,UAAU/F,OAAOZ,CAAP,CAAS8G,KAAT,CAAe,CAAf,EAAkB,CAAC,CAAnB,CAAX,EAAkC,aAAa,gBAA/C,EAAiE,eAAe,KAAKxG,IAAL,CAAUS,KAAV,CAAgBgG,YAAhG,EAAxB;;AAEA7B,mBAAO8B,EAAP,CAAU,WAAV,EAAuB,SAASC,WAAT,CAAqBC,GAArB,EAA0B;AAC/C,kBAAMC,QAAQD,IAAIE,MAAlB;AACAD,oBAAME,YAAN;AACA,mBAAKC,SAAL;AACD,aAJD;;AAMA,gBAAI,CAAC,KAAKhH,IAAL,CAAUS,KAAV,CAAgBgG,YAArB,EAAmC;AACjC7B,qBAAO8B,EAAP,CAAU,UAAV,EAAsB,SAASO,UAAT,GAAsB;AAC1CrC,uBAAOsC,UAAP;AACD,eAFD;AAGD;AACF;;;mCAEQxD,K,EAAO;AACd,iBAAK,IAAInB,QAAQ,KAAKvC,IAAL,CAAUoC,IAAV,CAAeD,UAAf,CAA0BK,MAA3C,EAAmDD,QAAQ,CAA3D,EAA8DA,SAAS,CAAvE,EAA0E;AACxE,kBAAImB,SAAS,KAAK1D,IAAL,CAAUoC,IAAV,CAAeD,UAAf,CAA0BI,QAAQ,CAAlC,CAAb,EAAmD;AACjD,uBAAO,KAAKvC,IAAL,CAAUS,KAAV,CAAgB6B,MAAhB,CAAuBC,KAAvB,CAAP;AACD;AACF;AACD,mBAAO9C,EAAE0H,KAAF,CAAQ,KAAKnH,IAAL,CAAUS,KAAV,CAAgB6B,MAAxB,CAAP;AACD;;;kCAEO8E,G,EAAI;AACVA,kBAAMA,IAAIC,KAAJ,CAAU,sEAAV,CAAN;AACA,mBAAQD,OAAOA,IAAI5E,MAAJ,KAAe,CAAvB,GAA4B,MACjC,CAAC,MAAMvB,SAASmG,IAAI,CAAJ,CAAT,EAAgB,EAAhB,EAAoBE,QAApB,CAA6B,EAA7B,CAAP,EAAyCC,KAAzC,CAA+C,CAAC,CAAhD,CADiC,GAEjC,CAAC,MAAMtG,SAASmG,IAAI,CAAJ,CAAT,EAAgB,EAAhB,EAAoBE,QAApB,CAA6B,EAA7B,CAAP,EAAyCC,KAAzC,CAA+C,CAAC,CAAhD,CAFiC,GAGjC,CAAC,MAAMtG,SAASmG,IAAI,CAAJ,CAAT,EAAgB,EAAhB,EAAoBE,QAApB,CAA6B,EAA7B,CAAP,EAAyCC,KAAzC,CAA+C,CAAC,CAAhD,CAHK,GAGgD,EAHvD;AAIC;;;qCAEQ;AACT,iBAAK3E,SAAL;AACA;AACA,gBAAMxC,WAAW,EAAjB;AACA,gBAAIoH,WAAW/H,EAAEgI,GAAF,CAAMhI,EAAEmB,GAAF,CAAM,KAAKZ,IAAL,CAAUoC,IAAhB,EAAsB,OAAtB,CAAN,CAAf;AACA,gBAAIsF,WAAWjI,EAAEkI,GAAF,CAAMlI,EAAEmB,GAAF,CAAM,KAAKZ,IAAL,CAAUoC,IAAhB,EAAsB,OAAtB,CAAN,CAAf;;AAEA,iBAAKpC,IAAL,CAAUoC,IAAV,CAAeiC,OAAf,CAAuB,qBAAa;AAClC,kBAAI,CAACC,UAAUC,YAAf,EAA6B;AAC7B,kBAAIqD,kBAAkB,CAACtD,UAAUZ,KAAV,GAAkB8D,QAAnB,KAAgCE,WAAWF,QAA3C,CAAtB;AACA;AACA,kBAAIK,YAAY,CAACvD,UAAUkB,gBAAX,EAA6BlB,UAAUmB,iBAAvC,EAA0DnB,UAAUZ,KAApE,CAAhB;AACAtD,uBAAS0H,IAAT,CAAcD,SAAd;AACD,aAND;;AAQA,gBAAIE,UAAUtI,EAAEkI,GAAF,CAAM,KAAK3H,IAAL,CAAUoC,IAAV,CAAeD,UAArB,CAAd;AACA,gBAAI6F,UAAU,CAAd,CAhBS,CAgBO;AAChB,gBAAIC,YAAYF,OAAhB,CAjBS,CAiBe;AACxB;AACA,gBAAIG,eAAe,EAAnB;AACAA,yBAAa,CAAb,IAAkB,KAAKC,OAAL,CAAa,KAAKnI,IAAL,CAAUS,KAAV,CAAgB6B,MAAhB,CAAuB,CAAvB,CAAb,CAAlB;AACA,iBAAK,IAAIC,QAAQ,CAAjB,EAAoBA,QAAQ,KAAKvC,IAAL,CAAUoC,IAAV,CAAeD,UAAf,CAA0BK,MAAtD,EAA8DD,OAA9D,EAAuE;AACrE,kBAAI6F,SAAS,CAAC,KAAKpI,IAAL,CAAUoC,IAAV,CAAeD,UAAf,CAA0BI,KAA1B,IAAmCyF,OAApC,KAAgDD,UAAUC,OAA1D,CAAb;AACA,kBAAII,SAAS,CAAb,EAAqBA,SAAS,CAAT,CAArB,KACK,IAAIA,SAAS,CAAb,EAAgBA,SAAS,CAAT;AACrBF,2BAAaE,MAAb,IAAuB,KAAKD,OAAL,CAAa,KAAKnI,IAAL,CAAUS,KAAV,CAAgB6B,MAAhB,CAAuBC,QAAM,CAA7B,CAAb,CAAvB;AACD;AACD,gBAAImD,SAASzE,SAAS,KAAKjB,IAAL,CAAUS,KAAV,CAAgB4H,QAAzB,CAAb;AAAA,gBAAiDC,OAAOrH,SAAS,KAAKjB,IAAL,CAAUS,KAAV,CAAgB8H,QAAzB,CAAxD;AACA,gBAAIC,WAAW,EAAC9C,QAAOA,MAAR,EAAe4C,MAAKA,IAApB,EAAyBX,KAAIM,SAA7B,EAAuCQ,UAASP,YAAhD,EAAf;AACA,iBAAKnE,SAAL,GAAiBzD,OAAOZ,CAAP,CAASqE,SAAT,CAAmB3D,QAAnB,EAA4BoI,QAA5B,EAAsC9G,KAAtC,CAA4C,KAAKd,GAAjD,CAAjB;AACA,iBAAKR,QAAL,GAAgBA,QAAhB;AACD;;;mCAEQ;AACP,iBAAKQ,GAAL,CAAS8H,cAAT;AACD;;;2CAEgB;AACf,iBAAK9H,GAAL,CAASO,KAAT,CAAe,CAACX,WAAW,KAAKR,IAAL,CAAUS,KAAV,CAAgBC,iBAA3B,CAAD,EAAgDF,WAAW,KAAKR,IAAL,CAAUS,KAAV,CAAgBE,kBAA3B,CAAhD,CAAf;AACA,iBAAKX,IAAL,CAAU2I,cAAV,GAA2B,KAA3B;AACD;;;yCAEc;AACb,iBAAKhH,MAAL,CAAYiH,UAAZ,CAAuB,KAAKhI,GAA5B;AACA,iBAAKe,MAAL,GAAc,IAAd;AACD;;;qCAEUxB,O,EAAS;AAClB,mBAAOG,OAAOZ,CAAP,CAASmJ,UAAT,CAAoB1I,OAApB,EAA6BuB,KAA7B,CAAmC,KAAKd,GAAxC,CAAP;AACD;;;0CAEe;AACd,iBAAKA,GAAL,CAASoD,WAAT,CAAqB,KAAKJ,YAA1B;AACD;;;kCAEOkF,U,EAAY;AAClB,iBAAKlI,GAAL,CAASmI,OAAT,CAAiB9H,SAAS6H,UAAT,EAAqB,EAArB,CAAjB;AACD;;;mCAEQ;AACP,iBAAK3I,OAAL,GAAe,EAAf;AACA,gBAAI,KAAKyD,YAAT,EAAuB,KAAKE,aAAL;AACvB,gBAAI,KAAKnC,MAAT,EAAiB,KAAKqH,YAAL;AACjB,iBAAKpI,GAAL,CAASqI,MAAT;AACD;;;;;;yBAlQkBlJ,Q","file":"worldmap.js","sourcesContent":["import _ from 'lodash';\n/* eslint-disable id-length, no-unused-vars */\n\nimport L from './libs/leaflet';\nimport './libs/leaflet-heat';\n/* eslint-disable id-length, no-unused-vars */\n\nconst tileServers = {\n  'CartoDB Positron': { url: 'https://cartodb-basemaps-{s}.global.ssl.fastly.net/light_all/{z}/{x}/{y}.png', attribution: '&copy; <a href=\"http://www.openstreetmap.org/copyright\">OpenStreetMap</a> &copy; <a href=\"http://cartodb.com/attributions\">CartoDB</a>', subdomains: 'abcd'},\n  'CartoDB Dark': {url: 'https://cartodb-basemaps-{s}.global.ssl.fastly.net/dark_all/{z}/{x}/{y}.png', attribution: '&copy; <a href=\"http://www.openstreetmap.org/copyright\">OpenStreetMap</a> &copy; <a href=\"http://cartodb.com/attributions\">CartoDB</a>', subdomains: 'abcd'}\n};\n\nexport default class WorldMap {\n  constructor(ctrl, mapContainer) {\n    this.ctrl = ctrl;\n    this.mapContainer = mapContainer;\n    this.createMap();\n    this.circles = {};\n    this.heatData = [];\n  }\n\n  createMap() {\n    const mapCenter = window.L.latLng(parseFloat(this.ctrl.panel.mapCenterLatitude), parseFloat(this.ctrl.panel.mapCenterLongitude));\n    this.map = window.L.map(this.mapContainer, {worldCopyJump: true, center: mapCenter})\n      .fitWorld()\n      .zoomIn(parseInt(this.ctrl.panel.initialZoom, 10));\n    this.map.panTo(mapCenter);\n\n    const selectedTileServer = tileServers[this.ctrl.tileServer];\n    window.L.tileLayer(selectedTileServer.url, {\n      maxZoom: 18,\n      subdomains: selectedTileServer.subdomains,\n      reuseTiles: true,\n      detectRetina: true,\n      attribution: selectedTileServer.attribution\n    }).addTo(this.map);\n  }\n\n  createLegend() {\n    this.legend = window.L.control({position: 'bottomleft'});\n    this.legend.onAdd = () => {\n      this.legend._div = window.L.DomUtil.create('div', 'info legend');\n      this.legend.update();\n      return this.legend._div;\n    };\n\n    this.legend.update = () => {\n      const thresholds = this.ctrl.data.thresholds;\n      let legendHtml = '';\n      legendHtml += '<i style=\"background:' + this.ctrl.panel.colors[0] + '\"></i> ' +\n          '&lt; ' + thresholds[0] + '<br>';\n      for (let index = 0; index < thresholds.length; index += 1) {\n        legendHtml +=\n          '<i style=\"background:' + this.getColor(thresholds[index] + 1) + '\"></i> ' +\n          thresholds[index] + (thresholds[index + 1] ? '&ndash;' + thresholds[index + 1] + '<br>' : '+');\n      }\n      this.legend._div.innerHTML = legendHtml;\n    };\n    this.legend.addTo(this.map);\n  }\n\n  drawOverlay() {\n    switch (this.ctrl.data.mapType) {\n      case \"circle\":\n        this.clearHeat();\n        this.drawCircles();\n        break;\n      case \"heat\":\n        this.clearCircles();\n        this.drawHeat();\n        break;\n      default:\n        break;\n    }\n  }\n\n  needToRedrawCircles(data) {\n    let nCirc = _.size(this.circles);\n    if (nCirc === 0 && data.length > 0) return true;\n    if (nCirc !== data.length) return true;\n    const locations = new Set(_.map(_.map(this.circles, 'options'), 'location'));\n    const dataPoints = new Set(_.map(data, 'key'));\n    return !_.isEqual(locations, dataPoints);\n  }\n\n  filterEmptyAndZeroValues(data) {\n    return _.filter(data, (o) => { return !(this.ctrl.panel.hideEmpty && _.isNil(o.value)) && !(this.ctrl.panel.hideZero && o.value === 0); });\n  }\n\n  clearCircles() {\n    if (this.circlesLayer) {\n      this.circlesLayer.clearLayers();\n      this.removeCircles(this.circlesLayer);\n      this.circles = {};\n    }\n  }\n\n  clearHeat() {\n    if (this.heatLayer) {\n      this.map.removeLayer(this.heatLayer);\n    }\n    this.heatData = [];\n  }\n\n  drawCircles() {\n    const data = this.filterEmptyAndZeroValues(this.ctrl.data);\n    if (this.needToRedrawCircles(data)) {\n      this.clearCircles();\n      this.createCircles(data);\n    } else {\n      this.updateCircles(data);\n    }\n  }\n\n  createCircles(data) {\n    const circles = {};\n    data.forEach(dataPoint => {\n      if (!dataPoint.locationName) return;\n      circles[dataPoint.key] = this.createCircle(dataPoint);\n    });\n    this.circlesLayer = this.addCircles(_.values(circles));\n    this.circles = circles;\n  }\n\n  updateCircles(data) {\n    data.forEach((dataPoint) => {\n      if (!dataPoint.locationName) return;\n\n      const circle = this.circles[dataPoint.key];\n      \n      if (circle) {\n        circle.setRadius(this.calcCircleSize(dataPoint.value || 0));\n        circle.setStyle({\n          color: this.getColor(dataPoint.value),\n          fillColor: this.getColor(dataPoint.value),\n          fillOpacity: 0.5,\n          location: dataPoint.key,\n        });\n        circle.unbindPopup();\n        this.createPopup(circle, dataPoint.locationName, dataPoint.valueRounded);\n      }\n    });\n  }\n\n  createCircle(dataPoint) {\n    const circle = window.L.circleMarker([dataPoint.locationLatitude, dataPoint.locationLongitude], {\n      radius: this.calcCircleSize(dataPoint.value || 0),\n      color: this.getColor(dataPoint.value),\n      fillColor: this.getColor(dataPoint.value),\n      fillOpacity: 0.5,\n      location: dataPoint.key\n    });\n\n    this.createPopup(circle, dataPoint.locationName, dataPoint.valueRounded);\n    return circle;\n  }\n\n  calcCircleSize(dataPointValue) {\n    const circleMinSize = parseInt(this.ctrl.panel.circleMinSize, 10) || 2;\n    const circleMaxSize = parseInt(this.ctrl.panel.circleMaxSize, 10) || 30;\n\n    if (this.ctrl.data.valueRange === 0) {\n      return circleMaxSize;\n    }\n\n    const dataFactor = (dataPointValue - this.ctrl.data.lowestValue) / this.ctrl.data.valueRange;\n    const circleSizeRange = circleMaxSize - circleMinSize;\n\n    return (circleSizeRange * dataFactor) + circleMinSize;\n  }\n\n  createPopup(circle, locationName, value) {\n    const unit = value && value === 1 ? this.ctrl.panel.unitSingular : this.ctrl.panel.unitPlural;\n    const label = (locationName + ': ' + value + ' ' + (unit || '')).trim();\n    circle.bindPopup(label, {'offset': window.L.point(0, -2), 'className': 'worldmap-popup', 'closeButton': this.ctrl.panel.stickyLabels});\n\n    circle.on('mouseover', function onMouseOver(evt) {\n      const layer = evt.target;\n      layer.bringToFront();\n      this.openPopup();\n    });\n\n    if (!this.ctrl.panel.stickyLabels) {\n      circle.on('mouseout', function onMouseOut() {\n        circle.closePopup();\n      });\n    }\n  }\n\n  getColor(value) {\n    for (let index = this.ctrl.data.thresholds.length; index > 0; index -= 1) {\n      if (value >= this.ctrl.data.thresholds[index - 1]) {\n        return this.ctrl.panel.colors[index];\n      }\n    }\n    return _.first(this.ctrl.panel.colors);\n  }\n\n  rgb2hex(rgb){\n    rgb = rgb.match(/^rgba?[\\s+]?\\([\\s+]?(\\d+)[\\s+]?,[\\s+]?(\\d+)[\\s+]?,[\\s+]?(\\d+)[\\s+]?/i);\n    return (rgb && rgb.length === 4) ? \"#\" +\n      (\"0\" + parseInt(rgb[1],10).toString(16)).slice(-2) +\n      (\"0\" + parseInt(rgb[2],10).toString(16)).slice(-2) +\n      (\"0\" + parseInt(rgb[3],10).toString(16)).slice(-2) : '';\n    }\n\n  drawHeat() {\n    this.clearHeat();\n    // build up the array to feed the heat layer\n    const heatData = [];\n    let minValue = _.min(_.map(this.ctrl.data, 'value'));\n    let maxValue = _.max(_.map(this.ctrl.data, 'value'));\n\n    this.ctrl.data.forEach(dataPoint => {\n      if (!dataPoint.locationName) return;\n      let normalizedValue = (dataPoint.value - minValue) / (maxValue - minValue);\n      // let heatPoint = [dataPoint.locationLatitude, dataPoint.locationLongitude, normalizedValue];\n      let heatPoint = [dataPoint.locationLatitude, dataPoint.locationLongitude, dataPoint.value];\n      heatData.push(heatPoint);\n    });\n\n    let maxGrad = _.max(this.ctrl.data.thresholds);\n    let minGrad = 0;//_.min(this.ctrl.data.thresholds);\n    let mapMaxVal = maxGrad;//_.max([maxGrad,maxValue]);\n    // gradient - color gradient config, e.g. {0.4: 'blue', 0.65: 'lime', 1: 'red'}\n    var gradientData = {};\n    gradientData[0] = this.rgb2hex(this.ctrl.panel.colors[0]);\n    for (let index = 0; index < this.ctrl.data.thresholds.length; index++) {\n      let thresh = (this.ctrl.data.thresholds[index] - minGrad) / (maxGrad - minGrad);\n      if (thresh > 1)      thresh = 1;\n      else if (thresh < 0) thresh = 0;\n      gradientData[thresh] = this.rgb2hex(this.ctrl.panel.colors[index+1]);\n    }\n    let radius = parseInt(this.ctrl.panel.heatSize), blur = parseInt(this.ctrl.panel.heatBlur);\n    let heatOpts = {radius:radius,blur:blur,max:mapMaxVal,gradient:gradientData};\n    this.heatLayer = window.L.heatLayer(heatData,heatOpts).addTo(this.map);\n    this.heatData = heatData;\n  }\n\n  resize() {\n    this.map.invalidateSize();\n  }\n\n  panToMapCenter() {\n    this.map.panTo([parseFloat(this.ctrl.panel.mapCenterLatitude), parseFloat(this.ctrl.panel.mapCenterLongitude)]);\n    this.ctrl.mapCenterMoved = false;\n  }\n\n  removeLegend() {\n    this.legend.removeFrom(this.map);\n    this.legend = null;\n  }\n\n  addCircles(circles) {\n    return window.L.layerGroup(circles).addTo(this.map);\n  }\n\n  removeCircles() {\n    this.map.removeLayer(this.circlesLayer);\n  }\n\n  setZoom(zoomFactor) {\n    this.map.setZoom(parseInt(zoomFactor, 10));\n  }\n\n  remove() {\n    this.circles = {};\n    if (this.circlesLayer) this.removeCircles();\n    if (this.legend) this.removeLegend();\n    this.map.remove();\n  }\n}\n"]}